{% extends "base.html" %}
{% block title %}User Management — PKI-Advanced{% endblock %}
{% block content %}

<div class="page-header">
    <div class="page-label">// ca admin — user management</div>
    <h1 class="page-title">Manage Users</h1>
    <p class="page-sub">Assign roles, activate or deactivate user accounts</p>
</div>

<!-- Role Legend -->
<div style="display:flex; gap:0.75rem; margin-bottom:1.5rem; flex-wrap:wrap; align-items:center">
    <span style="font-size:0.78rem; color:var(--muted)">Roles:</span>
    <span class="role-pill role-user">USER</span>
    <span style="font-size:0.75rem; color:var(--muted)">— Can request certificates</span>
    <span class="role-pill role-server_admin" style="margin-left:0.75rem">SERVER_ADMIN</span>
    <span style="font-size:0.75rem; color:var(--muted)">— Server cert management</span>
    <span class="role-pill role-ca_admin" style="margin-left:0.75rem">CA_ADMIN</span>
    <span style="font-size:0.75rem; color:var(--muted)">— Full system access</span>
</div>

<div class="card" style="padding:0">
    <div class="table-wrap" style="border:none">
        <table>
            <thead>
                <tr>
                    <th>#</th>
                    <th>Username</th>
                    <th>Email</th>
                    <th>Current Role</th>
                    <th>Joined</th>
                    <th>Last Login</th>
                    <th>Status</th>
                    <th>Change Role</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr>
                    <td class="mono text-muted" style="font-size:0.72rem">{{ user.id }}</td>
                    <td style="font-weight:700; color:var(--heading)">
                        {{ user.username }}
                        {% if user.id == current_user.id %}
                            <span style="font-size:0.65rem; color:var(--muted)">(you)</span>
                        {% endif %}
                    </td>
                    <td class="text-muted" style="font-size:0.78rem">{{ user.email }}</td>
                    <td>
                        <span class="role-pill role-{{ user.role_name }}">
                            {{ user.role_name | upper }}
                        </span>
                    </td>
                    <td class="mono" style="font-size:0.73rem">
                        {{ user.created_at.strftime('%Y-%m-%d') }}
                    </td>
                    <td class="mono" style="font-size:0.73rem; color:var(--muted)">
                        {{ user.last_login.strftime('%Y-%m-%d %H:%M') if user.last_login else '—' }}
                    </td>
                    <td>
                        {% if user.is_active %}
                            <span class="badge badge-active">● Active</span>
                        {% else %}
                            <span class="badge badge-revoked">✕ Inactive</span>
                        {% endif %}
                    </td>

                    <!-- Role change dropdown -->
                    <td>
                        {% if user.id != current_user.id %}
                        <form method="POST" action="/admin/users/role/{{ user.id }}"
                              style="display:flex; gap:0.4rem; align-items:center">
                            <select name="role" style="padding:0.3rem 0.5rem; font-size:0.75rem;
                                    background:var(--surface); color:var(--heading);
                                    border:1px solid var(--border); border-radius:6px">
                                {% for role in roles %}
                                <option value="{{ role.name }}"
                                    {{ 'selected' if role.name == user.role_name }}>
                                    {{ role.name }}
                                </option>
                                {% endfor %}
                            </select>
                            <button type="submit" class="btn btn-primary btn-sm">Set</button>
                        </form>
                        {% else %}
                        <span class="text-muted" style="font-size:0.75rem">Cannot change own role</span>
                        {% endif %}
                    </td>

                    <!-- Activate / Deactivate -->
                    <td>
                        {% if user.id != current_user.id %}
                        <form method="POST" action="/admin/users/toggle/{{ user.id }}"
                              onsubmit="return confirm('{{ 'Deactivate' if user.is_active else 'Activate' }} {{ user.username }}?')">
                            {% if user.is_active %}
                            <button type="submit" class="btn btn-danger btn-sm">Deactivate</button>
                            {% else %}
                            <button type="submit" class="btn btn-success btn-sm">Activate</button>
                            {% endif %}
                        </form>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Summary -->
<div style="margin-top:1rem; display:flex; gap:1.5rem; font-family:var(--mono); font-size:0.75rem; color:var(--muted)">
    <span>Total users: <strong style="color:var(--heading)">{{ users|length }}</strong></span>
    <span>Active: <strong style="color:var(--accent2)">{{ users|selectattr('is_active')|list|length }}</strong></span>
    <span>CA Admins: <strong style="color:var(--accent)">{{ users|selectattr('role_name','eq','ca_admin')|list|length }}</strong></span>
</div>
{% endblock %}