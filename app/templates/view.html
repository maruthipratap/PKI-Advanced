{% extends "base.html" %}
{% block title %}
    {% if list_mode %}All Certificates{% else %}Certificate Detail{% endif %} ‚Äî PKI-Advanced
{% endblock %}

{% block content %}
{% if list_mode %}
<!-- ‚îÄ‚îÄ LIST MODE ‚îÄ‚îÄ -->
<div class="page-header">
    <div class="page-label">// certificate registry</div>
    <h1 class="page-title">All Certificates</h1>
    <p class="page-sub">Complete list of issued certificates and their current status</p>
</div>

{% if certs %}
<div class="table-wrap">
    <table>
        <thead>
            <tr>
                <th>#</th>
                <th>Owner</th>
                <th>Email</th>
                <th>Organization</th>
                <th>Issued</th>
                <th>Expires</th>
                <th>Status</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            {% for cert in certs %}
            <tr>
                <td class="mono text-muted" style="font-size:0.75rem">{{ cert.id }}</td>
                <td style="font-weight:700; color:var(--heading)">{{ cert.owner_name }}</td>
                <td class="text-muted" style="font-size:0.8rem">{{ cert.email or '‚Äî' }}</td>
                <td class="text-muted" style="font-size:0.8rem">{{ cert.organization or '‚Äî' }}</td>
                <td class="mono" style="font-size:0.75rem">{{ cert.issued_at.strftime('%Y-%m-%d') }}</td>
                <td class="mono" style="font-size:0.75rem">{{ cert.valid_to.strftime('%Y-%m-%d') }}</td>
                <td>
                    {% if cert.status == 'ACTIVE' and not cert.is_expired() %}
                        <span class="badge badge-active">‚óè ACTIVE</span>
                    {% elif cert.status == 'REVOKED' %}
                        <span class="badge badge-revoked">‚úï REVOKED</span>
                    {% else %}
                        <span class="badge badge-expired">‚è∞ EXPIRED</span>
                    {% endif %}
                </td>
                <td><a href="/view/{{ cert.id }}" class="text-accent" style="font-size:0.8rem; text-decoration:none">View ‚Üí</a></td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<div class="card" style="text-align:center; padding:4rem; color:var(--muted)">
    <div style="font-size:3rem; margin-bottom:1rem">üìã</div>
    <div>No certificates issued yet.</div>
    <a href="/issue" class="btn btn-primary" style="margin-top:1.5rem; display:inline-flex">Issue First Certificate</a>
</div>
{% endif %}

{% else %}
<!-- ‚îÄ‚îÄ DETAIL MODE ‚îÄ‚îÄ -->
<div style="max-width:720px; margin:0 auto">
    <div class="page-header">
        <div class="page-label">// certificate detail</div>
        <h1 class="page-title">{{ cert.owner_name }}</h1>
        <p class="page-sub">X.509 End-Entity Certificate</p>
    </div>

    <div class="card">
        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:1.5rem">
            <div class="page-label" style="margin-bottom:0">// certificate fields</div>
            {% if cert.status == 'ACTIVE' and not cert.is_expired() %}
                <span class="badge badge-active">‚óè ACTIVE</span>
            {% elif cert.status == 'REVOKED' %}
                <span class="badge badge-revoked">‚úï REVOKED</span>
            {% else %}
                <span class="badge badge-expired">‚è∞ EXPIRED</span>
            {% endif %}
        </div>

        <div class="cert-field">
            <span class="cert-field-label">Common Name (CN)</span>
            <span class="cert-field-value">{{ cert.owner_name }}</span>
        </div>
        <div class="cert-field">
            <span class="cert-field-label">Email Address</span>
            <span class="cert-field-value">{{ cert.email or '‚Äî' }}</span>
        </div>
        <div class="cert-field">
            <span class="cert-field-label">Organization</span>
            <span class="cert-field-value">{{ cert.organization or '‚Äî' }}</span>
        </div>
        <div class="cert-field">
            <span class="cert-field-label">Issued By</span>
            <span class="cert-field-value">{{ cert.issued_by }}</span>
        </div>
        <div class="cert-field">
            <span class="cert-field-label">Serial Number</span>
            <span class="cert-field-value mono" style="font-size:0.75rem; word-break:break-all">{{ cert.serial_number }}</span>
        </div>
        <div class="cert-field">
            <span class="cert-field-label">Valid From</span>
            <span class="cert-field-value">{{ cert.valid_from.strftime('%Y-%m-%d %H:%M:%S UTC') }}</span>
        </div>
        <div class="cert-field">
            <span class="cert-field-label">Valid To</span>
            <span class="cert-field-value">{{ cert.valid_to.strftime('%Y-%m-%d %H:%M:%S UTC') }}</span>
        </div>
        <div class="cert-field">
            <span class="cert-field-label">Issued At</span>
            <span class="cert-field-value">{{ cert.issued_at.strftime('%Y-%m-%d %H:%M:%S UTC') }}</span>
        </div>

        <!-- PEM Block -->
        <div style="margin-top:1.5rem">
            <div class="cert-field-label" style="margin-bottom:0.5rem">Certificate (PEM Format)</div>
            <div class="pem-block">{{ cert.cert_pem }}</div>
        </div>

        <!-- Actions -->
        <div style="display:flex; gap:0.75rem; margin-top:1.5rem; flex-wrap:wrap">
            <a href="/verify" class="btn btn-ghost">üîç Verify</a>
        
            {% if cert.status == 'ACTIVE' and not cert.is_expired() %}
                <!-- Revoke button ‚Äî owner or ca_admin -->
                {% if current_user.is_ca_admin() or cert.owner_name == current_user.username %}
                <a href="/revoke" class="btn btn-danger">üö´ Revoke</a>
                {% endif %}
            {% endif %}
        
            {% if cert.status == 'ACTIVE' or cert.is_expired() %}
                <!-- Renew button ‚Äî owner or ca_admin -->
                {% if current_user.is_ca_admin() or cert.owner_name == current_user.username %}
                <form method="POST" action="/renew/{{ cert.id }}" style="display:inline"
                      onsubmit="return confirm('Renew this certificate? The old one will be revoked.')">
                    <button type="submit" class="btn btn-success">üîÑ Renew Certificate</button>
                </form>
                {% endif %}
            {% endif %}
            
            <a href="/certificates" class="btn btn-ghost">‚Üê All Certificates</a>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}